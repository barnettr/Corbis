/* 
                    .+~                :xx++::
                   :`. -          .!!X!~"?!`~!~!. :-:.
                  <             .!!!H":.~ ::+!~~!!!~ `%X.
                  '             ~~!M!!>!!X?!!!!!!!!!!...!~.
                              <!:!MM!~:XM!!!!!!.:!..~ !.  `<
                  <: `   :~ .:<~!!M!XXHM!!!X!XXHtMMHHHX!  ~ ~
                ~~~~<' ~!!!:!!!!!XM!!M!!!XHMMMRMSXXX!!!!!!:  <`
                  `<  <::!!!!!X!X?M!!M!!XMMMMXXMMMM??!!!!!?!:~<
               : '~~~<!!!XMMH!!XMXMXHHXXXXM!!!!MMMMSXXXX!!!!!!!~
            :    ::`~!!!MMMMXXXtMMMMMMMMMMMHX!!!!!!HMMMMMX!!!!!: ~
               '~:~!!!!!MMMMMMMMMMMMMMMMMMMMMMXXX!!!M??MMMM!!X!!i:
               <~<!!!!!XMMMMMMMMMMMM8M8MMMMM8MMMMMXX!!!!!!!!X!?t?!:
               ~:~~!!!!?MMMMMM@M@RMRRR$@@MMRMRMMMMMMXSX!!!XMMMX<?X!
             :XX <!!XHMMMM88MM88BR$M$$$$8@8RN88MMMMMMMMHXX?MMMMMX!!!
           .:X! <XMSM8M@@$$$$$$$$$$$$$$$$$$$B8R$8MMMMMMMMMMMMMMMMX!X
          :!?! !?XMMMMM8$$$$8$$$$$$$$$$$$$$BBR$$MMM@MMMMMMMMMMMMMM!!X
        ~<!!~ <!!XMMMB$$$$$$$$$$$$$$$$$$$$$$$$MMR$8MR$MMMMMMMMMMMMM!?!:
        :~~~ !:X!XMM8$$$$$$$$$$$$$$$$$$$$$$$RR$$MMMMR8NMMMMMMMMMMMMM<!`-
    ~:<!:~`~':!:HMM8N$$$$$$$$$$$$$$$$$$$$$$$$$8MRMM8R$MRMMMMMMMMRMMMX!
  !X!``~~   :~XM?SMM$B$$$$$$$$$$$$$$$$$$$$$$BR$$MMM$@R$M$MMMMMM$MMMMX?L
 X~.      : `!!!MM#$RR$$$$$$$$$$$$$$$$$R$$$$$R$M$MMRRRM8MMMMMMM$$MMMM!?:
 ! ~ <~  !! !!~`` :!!MR$$$$$$$$$$RMM!?!??RR?#R8$M$MMMRM$RMMMM8MM$MMM!M!:>
: ' >!~ '!!  !   .!XMM8$$$$$@$$$R888HMM!!XXHWX$8$RM$MR5$8MMMMR$$@MMM!!!< ~
!  ' !  ~!! :!:XXHXMMMR$$$$$$$$$$$$$$$$8$$$$8$$$MMR$M$$$MMMMMM$$$MMM!!!!
 ~<!!!  !!! !!HMMMMMMMM$$$$$$$$$$$$$$$$$$$$$$$$$$MMM$M$$MM8MMMR$$MMXX!!!!/:`
  ~!!!  !!! !XMMMMMMMMMMR$$$$$$$$$$$$R$RRR$$$$$$$MMMM$RM$MM8MM$$$M8MMMX!!!!:
  !~ ~  !!~ XMMM%!!!XMMX?M$$$$$$$$B$MMSXXXH?MR$$8MMMM$$@$8$M$B$$$$B$MMMX!!!!
  ~!    !! 'XMM?~~!!!MMMX!M$$$$$$MRMMM?!%MMMH!R$MMMMMM$$$MM$8$$$$$$MR@M!!!!!
  <>    !!  !Mf x@#"~!t?M~!$$$$$RMMM?Xb@!~`??MS$M@MMM@RMRMMM$$$$$$RMMMMM!!!!
  !    '!~ <!!:!?M   !@!M<XM$$R5M$8MMM$! -XXXMMRMBMMM$RMMM@$R$BR$MMMMX??!X!!
  !    '!  !!X!!!?::xH!HM:MM$RM8M$RHMMMX...XMMMMM$RMMRRMMMMMMM8MMMMMMMMX!!X!
  !     ~  !!?:::!!!MXMR~!MMMRMM8MMMMMS!!M?XXMMMMM$$M$M$RMMMM8$RMMMMMMMM%X!!
  ~     ~  !~~X!!XHMMM?~ XM$MMMMRMMMMMM@MMMMMMMMMM$8@MMMMMMMMRMMMMM?!MMM%HX!
           !!!!XSMMXXMM .MMMMMMMM$$$BB8MMM@MMMMMMMR$RMMMMMMMMMMMMMMMXX!?H!XX
           XHXMMMMMMMM!.XMMMMMMMMMR$$$8M$$$$$M@88MMMMMMMMMMMMMMM!XMMMXX!!!XM
      ~   <!MMMMMMMMRM:XMMMMMMMMMM8R$$$$$$$$$$$$$$$NMMMMMMMM?!MM!M8MXX!!/t!M
      '   ~HMMMMMMMMM~!MM8@8MMM!MM$$8$$$$$$$$$$$$$$8MMMMMMM!!XMMMM$8MR!MX!MM
          'MMMMMMMMMM'MM$$$$$MMXMXM$$$$$$$$$$$$$$$$RMMMMMMM!!MMM$$$$MMMMM<!M
          'MMMMMMMMM!'MM$$$$$RMMMMMM$$$$$$$$$$$$$$$MMM!MMMX!!MM$$$$$M$$M$M!M
           !MMMMMM$M! !MR$$$RMM8$8MXM8$$$$$$$$$$$$NMMM!MMM!!!?MRR$$RXM$$MR!M
           !M?XMM$$M.< !MMMMMMSUSRMXM$8R$$$$$$$$$$#$MM!MMM!X!t8$M$MMMHMRMMX$
    ,-,   '!!!MM$RMSMX:.?!XMHRR$RM88$$$8M$$$$$R$$$$8MM!MMXMH!M$$RMMMMRNMMX!$
   -'`    '!!!MMMMMMMMMM8$RMM8MBMRRMR8RMMM$$$$8$8$$$MMXMMMMM!MR$MM!M?MMMMMM$
          'XX!MMMMMMM@RMM$MM@$$BM$$$M8MMMMR$$$$@$$$$MM!MMMMXX$MRM!XH!!??XMMM
          `!!!M?MHMMM$RMMMR@$$$$MR@MMMM8MMMM$$$$$$$WMM!MMMM!M$RMM!!.MM!%M?~!
           !!!!!!MMMMBMM$$RRMMMR8MMMMMRMMMMM8$$$$$$$MM?MMMM!f#RM~    `~!!!~!
           ~!!HX!!~!?MM?MMM??MM?MMMMMMMMMRMMMM$$$$$MMM!MMMM!!
           '!!!MX!:`~~`~~!~~!!!!XM!!!?!?MMMM8$$$$$MMMMXMMM!!
            !!~M@MX.. <!!X!!!!XHMHX!!``!XMMMB$MM$$B$M!MMM!!
            !!!?MRMM!:!XHMHMMMMMMMM!  X!SMMX$$MM$$$RMXMMM~
             !M!MMMM>!XMMMMMMMMXMM!!:!MM$MMMBRM$$$$8MMMM~
             `?H!M$R>'MMMM?MMM!MM6!X!XM$$$MM$MM$$$$MX$f
              `MXM$8X MMMMMMM!!MM!!!!XM$$$MM$MM$$$RX@"
               ~M?$MM !MMMMXM!!MM!!!XMMM$$$8$XM$$RM!`
                !XMMM !MMMMXX!XM!!!HMMMM$$$$RH$$M!~
                'M?MM `?MMXMM!XM!XMMMMM$$$$$RM$$#
                 `>MMk ~MMHM!XM!XMMM$$$$$$BRM$M"
                  ~`?M. !M?MXM!X$$@M$$$$$$RMM#
                    `!M  !!MM!X8$$$RM$$$$MM#`
                      !% `~~~X8$$$$8M$$RR#`
                       !!x:xH$$$$$$$R$R*`
                        ~!?MMMMRRRM@M#`       -Search is delicious-
                         `~???MMM?M"`
                             ``~~
*/

//Moved code from here to AddToLightbox.ascx

// Due to the similarity of function for search load progress, attach the progress handling function here -- MIKE

/***************************
SCRIPT VARIABLES
****************************/
var timer, timer2, thumbTips, noLicense, noCat, noColor, noPhoto;
var _clarifyCheckCount = 0;
var stopSearch = false;

/****************************
NAMESPACES
****************************/
if (typeof(CorbisUI) == 'undefined') {
    CorbisUI = {};
}

if (typeof (CorbisUI.Search) == 'undefined') {
    CorbisUI.Search = {};
}

if (typeof (CorbisUI.Handlers) == 'undefined') {
    CorbisUI.Handlers = {};
}

if (typeof (CorbisUI.ProductCache) == 'undefined') {
    CorbisUI.ProductCache = new CorbisUI.CachingClass();   
}






	

/////////////////////////////////////
// MAIN SEARCH NAMESPACE OBJECT
/////////////////////////////////////

CorbisUI.Search = {

    MoveQuickPick: function(ctl, ctl2, corbisId, Url128, licenseModel, aspectRatio, title, toQuickPick) {
        // see if quickpic tab is active, if not then "click" it
        // this interacts with objects in SearchBuddy.js
        if (CorbisUI.SearchBuddy.init.activeTab != "quickpic") {
            var qp = CorbisUI.SearchBuddy.init.tabs.get("quickpic");
            qp.el.fireEvent('click');
        }

        if (toQuickPick) {

            Corbis.Web.UI.Search.SearchScriptService.AddItemToQuickPick(corbisId, Url128, licenseModel, aspectRatio, title, updateQuickPicView, methodFailed);
            var item = $(ctl);
            item.getParent().addClass('hdn');
            var hideQP = item.getParent('ul').getElement('.QP_off');
            if (hideQP) {
                hideQP.removeClass('hdn');
            }
        }
        else {
            Corbis.Web.UI.Search.SearchScriptService.RemoveItemFromQuickPick(corbisId, updateQuickPicView, methodFailed)
            var item = $(ctl);
            item.getParent().addClass('hdn');
            var ulItem = item.getParent('ul');
            if (ulItem) {
                var showQP = ulItem.getElement('.QP_on');
                if (showQP) {
                    showQP.removeClass('hdn');
                }
            }
        }

    },

    WindowScrollFX: null,

    SetPageFocus: function() {
        if (this.WindowScrollFX == null) {
            this.WindowScrollFX = new Fx.Scroll($(window), {
                offset: {
                    'x': 0,
                    'y': 0
                }
            });
        }
        if ($('ProductResults') != null) this.WindowScrollFX.toTop();
    }
};

CorbisUI.QueueManager.addQueue('SearchMacros', {
    canRerun: true,
    delay: true
}).addItem('pageScrollToTop', function() {
    CorbisUI.Search.SetPageFocus();
});



/////////////////////////////////////
// HANDLER FUNCTIONS
/////////////////////////////////////


CorbisUI.Search.Handler = {

    fetchProductObject: function(id, idType) {
        switch (idType) {
            case "productuid":
                return CorbisUI.ProductCache.get(id);
                break;
            case "corbisid":
                var productuid = CorbisUI.ProductCache.get(id);
                return CorbisUI.ProductCache.get(productuid);
                break;
        }
    },

    selectQuickpicIcon: function(id, idType) {
        var product = this.fetchProductObject(id, idType);
        (function() {
            product.refreshObject()
                .updateIcon('QP', 'selectIcon');
        }).delay(200);
    },

    deselectQuickpicIcon: function(id, idType) {
        var product = this.fetchProductObject(id, idType);
        (function() {
            product.refreshObject()
                .updateIcon('QP', 'deselectIcon');
        }).delay(200);
    },

    syncLightboxToImages: function() {
        CorbisUI.Handlers.Lightbox.syncLightboxToImages();
        //        //deselect all selected images
        //        CorbisUI.DomCache.get('ProductResults').getElements('span.ProductBlock').each(function(el) {
        //            //var productBlock = el.retrieve('objectReference');
        //            var productid = el.getProperty('productuid');

        //            var productBlock = CorbisUI.ProductCache.get(productid);
        //            //productBlock.setupObject();
        //            //if (productBlock.activeStates.LB) {
        //            if (productBlock.checkLightboxStatus()) {
        //                productBlock.updateIcon('LB', 'deselectIcon');
        //            }
        //        });

        //        //Update images that's in current lightbox
        //        CorbisUI.DomCache.get('SBBX_lightboxes').getElements('div.lightboxBlock').each(function(el) {
        //            var lightboxImage = CorbisUI.ProductCache.get(el.getProperty('mediaUid'));
        //            if (lightboxImage != null) lightboxImage.refreshObject().updateIcon('LB', 'selectIcon');
        //        });
    },

    addProductToCart: function(corbisId) {
        if (CorbisUI.Auth.GetSignInLevel() < 1) {
            CorbisUI.Auth.Check(1, CorbisUI.Auth.ActionTypes.Execute, "CorbisUI.Search.Handler.doAddProductToCart('" + corbisId + "')");
        } else {
            CorbisUI.Search.Handler.doAddProductToCart(corbisId);
        }
    },

    doAddProductToCart: function(corbisId, reloadPage) {
        var mediaId = CorbisUI.ProductCache.get(corbisId);
        var product = CorbisUI.ProductCache.get(mediaId);
        if (product) product.refreshObject().setRefreshPage(reloadPage).addProductToCart();
    },

    refreshCartItem: function(corbisId, cartItemCount) {
        var mediaId = CorbisUI.ProductCache.get(corbisId);
        CorbisUI.Handlers.Cart.refreshItemAdded(mediaId, corbisId, cartItemCount);
    },

    refreshQuickPicBuddy: function() {
        var quickpicField = CorbisUI.DomCache.get('SBBX_quickpic').getElement('input[id$=quickpicField]');
        quickpicField.onclick(); //AJAX control
        var quickpicTab = CorbisUI.DomCache.get('SearchBuddy').getElement('li.SBT_quickpic');
        quickpicTab.fireEvent('click'); //MooTool event
    }
};


/////////////////////////////////////
// NEW HANDLER FUNCTIONS
/////////////////////////////////////

CorbisUI.Handlers.Lightbox = {

    currentLightboxItems: null,
    afterSignIn_cookieEvent: function(vars) {
        //1.get lightbox id first
        var lightboxId = CorbisUI.DomCache.get('SBBX_lightboxes').getElement('select.lightboxList').getSelected()[0].value;
        //2.do the ajax call
        Corbis.Web.UI.Search.SearchScriptService.AddSearchItemToLightbox(vars.MID, lightboxId,
                    function() { CorbisUI.SearchBuddy.activateTab("lightboxes") }, CorbisUI.Handlers.Lightbox.methodFailed);
    },
    afterSignIn: function(CorbisId) {

        var mediaId = CorbisUI.ProductCache.get(CorbisId);

        // setup cookie event
        CorbisUI.CookieEvents.addCookieEvent(function() {
            CorbisUI.Handlers.Lightbox.afterSignIn_cookieEvent(this.vars);
        }, { CID: CorbisId, MID: mediaId });

        window.location.reload();

    },
    addTo: function(CorbisId) {
        //console.log('CALLING: CorbisUI.Handlers.Lightbox.addTo');
        if (CorbisUI.Auth.GetSignInLevel() < 1) {
            CorbisUI.Auth.Check(1, CorbisUI.Auth.ActionTypes.Execute, "CorbisUI.Handlers.Lightbox.afterSignIn('" + CorbisId + "'); ");
        }
        else {
            CorbisUI.Handlers.Lightbox.addProductToLightbox(CorbisId);
        }
    },
    addProductToLightbox: function(CorbisId, reloadPage) {
        LogOmnitureEvent("event12"); 
        
        //console.log('CALLING: CorbisUI.Handlers.Lightbox.addProductToLightbox');
        var mediaId = CorbisUI.ProductCache.get(CorbisId);
        var product = CorbisUI.ProductCache.get(mediaId);
        product.refreshObject().setupObject();

        if (reloadPage) product.refreshPage = reloadPage;

        if (!product.activeStates.LB) {
            CorbisUI.SearchBuddy.init.tabs.get('lightboxes').el.fireEvent('click');
            //1.get lightbox id first
            var lightboxId = CorbisUI.DomCache.get('SBBX_lightboxes').getElement('select.lightboxList').getSelected()[0].value;
            //2.do the ajax call
            Corbis.Web.UI.Search.SearchScriptService.AddSearchItemToLightboxNew(product.corbisID, mediaId, lightboxId, CorbisUI.Handlers.Lightbox.addToResponseNew, CorbisUI.Handlers.Lightbox.methodFailed);
            //            var addToLightbox = new CorbisUI.Lightbox.AddToLightbox(product.productUID);
            //            addToLightbox.context = product;
            //            addToLightbox.onSuccess = CorbisUI.Handlers.Lightbox.addToResponse;
            //            addToLightbox.refreshPage = reloadPage;
            //            addToLightbox.addOfferingToLightbox();
        }
    },
    reloadLightbox: function(lightboxId, lightboxName) {
        var lightboxList;
        var isMediasetSearch = false;
        //TODO: mediasetsearch buddy has lightbox in SBBX_filters, need to consolidate at some stage.
        if (CorbisUI.DomCache.get('SBBX_lightboxes')) {
            lightboxList = CorbisUI.DomCache.get('SBBX_lightboxes').getElement('select.lightboxList');
        }
        else if (CorbisUI.DomCache.get('SBBX_filters')) {
            lightboxList = CorbisUI.DomCache.get('SBBX_filters').getElement('select.lightboxList');
            isMediasetSearch = true;
        }

        if (lightboxList) {
            if (lightboxName) {
                var option = new Option(lightboxName, lightboxId);
                try {
                    lightboxList.add(option, null);
                }
                catch (Error) {
                    lightboxList.add(option);
                }
            }

            var curLightboxId = lightboxList.getSelected()[0].value;
            if (curLightboxId != lightboxId) {
                var curLightbox = lightboxList.getElement('option[value=' + lightboxId + ']');
                if (curLightbox) curLightbox.selected = true;
            }

            if (isMediasetSearch) {
                $(CorbisUI.GlobalVars.SearchResults.refreshLightboxControl).onclick();
            }
            else {
                if (CorbisUI.SearchBuddy.init.tabs.get('lightboxes').dataLoaded ||
                    CorbisUI.SearchBuddy.init.tabs.get('lightboxes').buddy.activeTab == 'lightboxes') {
                    CorbisUI.Handlers.Lightbox.getLightboxItems(lightboxId);
                }
                if (CorbisUI.SearchBuddy.init.tabs.get('lightboxes').buddy.activeTab != 'lightboxes') {
                    CorbisUI.SearchBuddy.init.tabs.get('lightboxes').el.fireEvent('click');
                }
            }

        }
    },
    addToResponseNew: function(result, context, methodName) {
        //To not break the existing functionality added this new method
        //console.log('CALLING: CorbisUI.Handlers.Lightbox.addToResponseNew');
        //1. highlight the current item
        //2. add it to the active lightbox
        new CorbisUI.SearchModels.lightboxBlock(result.MediaUID, result.CorbisID, { direction: 'top' }, result.RealProductUid);
        var count = CorbisUI.DomCache.get('LBXContainer').getElements('div.lightboxBlock').length;
        CorbisUI.Handlers.Lightbox.emptyItemDisplay(count);

        //increment image in lightbox count
        var imageCountProperty = CorbisUI.DomCache.get('LBXContainer').getProperty('imageCount');
        var imageCount = parseInt(imageCountProperty);
        if (!isNaN(imageCount)) {
            imageCount += 1;
        }
        else {
            //item already delete, so don't need to increment.
            imageCount = CorbisUI.DomCache.get('LBXContainer').getElements('div.lightboxBlock').length;
        }
        CorbisUI.DomCache.get('LBXContainer').setProperty('imageCount', imageCount.toString());
    },
    addToResponse: function(results, context, methodName) {
        //console.log('CALLING: CorbisUI.Handlers.Lightbox.addToResponse');
        //1. highlight the current item
        //2. add it to the active lightbox
        new CorbisUI.SearchModels.lightboxBlock(results, null, { direction: 'top' });
        var count = CorbisUI.DomCache.get('LBXContainer').getElements('div.lightboxBlock').length;
        CorbisUI.Handlers.Lightbox.emptyItemDisplay(count);
    },

    deleteItem: function(el) {
        //console.log('CALLING: CorbisUI.Handlers.Lightbox.deleteItem');
    },

    deleteItemResponse: function(results, context, methodName) {
        //console.log('CALLING: CorbisUI.Handlers.Lightbox.deleteItemResponse');
    },
    emptyItemDisplay: function(count) {
        //console.log('CALLING: CorbisUI.Handlers.Lightbox.emptyItemDisplay');
        if (CorbisUI.DomCache.get('LBXContainer').getElement('.centerMe') != null) {
            CorbisUI.DomCache.get('LBXContainer').getElement('.centerMe').setStyle('display', (count == 0) ? 'block' : 'none');
        }
    },
    getLightboxItems: function(lightboxId) {
        //console.log('CALLING: CorbisUI.Handlers.Lightbox.getLightboxItems');
        CorbisUI.DomCache.get('lightboxProgress').setStyle('display', 'block');
        if ($type(CorbisUI.Handlers.Lightbox.currentLightboxItems) == 'array') {
            CorbisUI.Handlers.Lightbox.currentLightboxItems.stopChunk();
        }
        Corbis.Web.UI.Search.SearchScriptService.GetLightBoxItems(lightboxId, CorbisUI.Handlers.Lightbox.getLightboxItemsResponse, CorbisUI.Handlers.Lightbox.methodFailed);
    },

    getLightboxItemsResponse: function(results, context, methodName) {
        //console.log('CALLING: CorbisUI.Handlers.Lightbox.getLightboxItemsResponse');
        CorbisUI.DomCache.get('lightboxProgress').setStyle('display', 'none');
        CorbisUI.DomCache.get('LBXContainer').getElements('.lightboxBlock').each(function(el) { el.destroy(); });
        CorbisUI.DomCache.get('LBXContainer').setProperty('imageCount', results.length);

        CorbisUI.Handlers.Lightbox.syncLightboxToImages();

        //console.log(results);
        //console.log(results);
        CorbisUI.Handlers.Lightbox.emptyItemDisplay(results.length);
        if (results.length > 0) {
            // cleanup the old items
            // display each lightbox item

            CorbisUI.Handlers.Lightbox.currentLightboxItems = results;
            CorbisUI.Handlers.Lightbox.currentLightboxItems.flip().chunk(CorbisUI.Handlers.Lightbox.chunkProcess, 50);
        }
    },
    methodFailed: function(results, context, methodName) {
        if (methodName == 'GetLightBoxItems') {
            CorbisUI.DomCache.get('lightboxProgress').setStyle('display', 'none');
            CorbisUI.DomCache.get('LBXContainer').getElements('.lightboxBlock').each(function(el) { el.destroy(); });
            CorbisUI.Handlers.Lightbox.resetLightboxToImages();
            CorbisUI.Handlers.Lightbox.emptyItemDisplay(results.length);
            alert(results.get_message());
        }
    },
    chunkProcess: function(item) {
        new CorbisUI.SearchModels.lightboxBlock(item);
    },

    syncLightboxToImages: function() {
        //deselect all selected images
        CorbisUI.DomCache.get('ProductResults').getElements('span.ProductBlock').each(function(el) {
            //var productBlock = el.retrieve('objectReference');
            var productid = el.getProperty('productuid');

            var productBlock = CorbisUI.ProductCache.get(productid);

            if (productBlock.checkLightboxStatus()) productBlock.updateIcon('LB', 'deselectIcon');
        });
        //Update images that's in current lightbox
        if (CorbisUI.DomCache.get('SBBX_lightboxes') != null) {
            CorbisUI.DomCache.get('SBBX_lightboxes').getElements('div.lightboxBlock').each(function(el) {
                var productBlock = CorbisUI.ProductCache.get(el.getProperty('mediaUid'));
                if (productBlock != null) productBlock.refreshObject().updateIcon('LB', 'selectIcon');
            });
        }
    },

    refreshItemAdded: function(corbisId, lightboxId, newLightboxName) {
        var mediaId = CorbisUI.ProductCache.get(corbisId);
        var product = CorbisUI.ProductCache.get(mediaId);

        if (product) {
            product.refreshObject().updateIcon('LB', 'selectIcon')
        }

        this.reloadLightbox(lightboxId, newLightboxName);
    }
};

CorbisUI.Handlers.Quickpic = {

    downloadAll: function() {

        if (CorbisUI.Auth.GetSignInLevel() < 2) {
            CorbisUI.Auth.Check(2, CorbisUI.Auth.ActionTypes.Execute, "CorbisUI.Handlers.Quickpic.downloadAll_openModal()");
        }
        else {
            CorbisUI.Handlers.Quickpic.downloadAll_openModal();
        }

    },

    downloadAll_openModal: function() {
        if ($('quickPicsContainer').getElements('div.quickPicBlock').length > 0) {
            OpenNewIModal(CorbisUI.GlobalVars.SearchResults.urls.downloadQuickPic, 640, 540, 'QuickPic');
        }
    },

    moveQuickpic: function(ctl, corbisId, Url128, licenseModel, aspectRatio, title) {
        //console.log('CALLING: CorbisUI.Handlers.Quickpic.moveQuickpic');
        var item = $(ctl).getParent();
        //console.log(item);
        var method = (item.hasClass('QP_on')) ? 'delete' : 'add';
        //console.log(method);

        // see if quickpic tab is active, if not then "click" it
        // this interacts with objects in SearchBuddy.js
        if (window.location.href.toLowerCase().contains('mylightboxes.aspx')) {
            var pageInit = CorbisUI.MyLightboxes.init;
        } else {
            var pageInit = CorbisUI.SearchBuddy.init;
        }
        if (pageInit.activeTab != "quickpic") {
            var qp = pageInit.tabs.get("quickpic");
            qp.el.fireEvent('click');
        }

        switch (method) {
            case 'delete':
                CorbisUI.Handlers.Quickpic.deleteItem(corbisId);
                break;
            case 'add':
                CorbisUI.Handlers.Quickpic.addTo(corbisId, Url128, licenseModel, aspectRatio, title);
                break;
        }

    },

    addTo: function(corbisId, Url128, licenseModel, aspectRatio, title) {
        LogOmnitureEvent("event15");
        //console.log('CALLING: CorbisUI.Handlers.Quickpic.addTo');
        Corbis.Web.UI.Search.SearchScriptService.AddItemToQuickPick(corbisId, Url128, licenseModel, aspectRatio, title, CorbisUI.Handlers.Quickpic.addToResponse, CorbisUI.Handlers.Quickpic.addTo_methodFailed);
    },

    addToResponse: function(results, context, methodName) {
        var corbisId = results;
        if (corbisId == "") {
            new CorbisUI.Popup('quickpicMaximumAlert', {
                showModalBackground: false,
                closeOnLoseFocus: true,
                positionVert: 'middle',
                positionHoriz: 'right'
            });

            ResizeModal('quickpicMaximumAlert');
        }
        else {
            //console.log('CALLING: CorbisUI.Handlers.Quickpic.addToResponse');

            //no product cache for lightbox, probably coming from enlargement, create new product
            if (!CorbisUI.ProductCache.has(results) && window.location.pathname.toLowerCase().endsWith('mylightboxes.aspx')) {
                var productBlock = new CorbisUI.Lightbox.ProductBlock(results);
            }

            var mediaId = CorbisUI.ProductCache.get(results);
            var product = CorbisUI.ProductCache.get(mediaId);
            if (CorbisUI.ProductCache.get("quickPicsContainer").getElement('div[corbisid=' + results + ']') == null) {
                new CorbisUI.SearchModels.quickPicBlock(mediaId, results);
            }
            var centerMe = CorbisUI.ProductCache.get("quickPicsContainer").getElement('.centerMe');
            if (!centerMe.hasClass('hdn')) centerMe.addClass('hdn');

            //var downloadAll = $('SBBX_quickpic').getElement('span[id$=quickPicDownloadAllLink]');
            CorbisUI.Handlers.Quickpic.emptyItemDisplay(1);
        }
    },

    addTo_methodFailed: function(results, context, methodName) {
        //console.log('CALLING: CorbisUI.Handlers.Quickpic.deleteItem_methodFailed');
        //console.log(results);
        //TODO: use mochaUI for alert window
        alert(results.get_message());
    },

    deleteItem: function(corbisId) {
        //console.log('CALLING: CorbisUI.Handlers.Quickpic.deleteItem');
        Corbis.Web.UI.Search.SearchScriptService.RemoveItemFromQuickPick(corbisId, CorbisUI.Handlers.Quickpic.deleteItemResponse, CorbisUI.Handlers.Quickpic.deleteItem_methodFailed);
    },

    deleteItemResponse: function(results, context, methodName) {
        //console.log('CALLING: CorbisUI.Handlers.Quickpic.deleteItemResponse');
        var mediaId = CorbisUI.ProductCache.get(results);
        var product = CorbisUI.ProductCache.get(mediaId);
        if (product) product.updateIcon('QP', 'deselectIcon');

        // need delete action below here
        //console.log(results);
        CorbisUI.ProductCache.get("quickPicsContainer").getElement('div[corbisid=' + results + ']').destroy();
        var qpBlocks = CorbisUI.ProductCache.get("quickPicsContainer").getElements('.quickPicBlock');
        if (qpBlocks.length == 0) CorbisUI.ProductCache.get("quickPicsContainer").getElement('.centerMe').removeClass('hdn');
        CorbisUI.Handlers.Quickpic.emptyItemDisplay(qpBlocks.length);

    },

    deleteItem_methodFailed: function(results, context, methodName) {
        //console.log('CALLING: CorbisUI.Handlers.Quickpic.deleteItem_methodFailed');
        //console.log(results);
        //TODO: use mochaUI for alert window
        alert(results.get_message());
    },
    emptyItemDisplay: function(count) {
        //console.log('CALLING: CorbisUI.Handlers.Quickpic.emptyItemDisplay');
        var downloadAll = $('SBBX_quickpic').getElement('span[id$=quickPicDownloadAllLink]');

        if (count > 0)
            downloadAll.removeClass('hdn');
        else
            downloadAll.addClass('hdn');

        //CorbisUI.DomCache.get('LBXContainer').getElement('.centerMe').setStyle('display', (count == 0) ? 'block' : 'none');
    },

    refreshItemAdded: function(corbisId) {
        var mediaId = CorbisUI.ProductCache.get(corbisId);
        var product = CorbisUI.ProductCache.get(mediaId);

        if (product) {
            product.refreshObject().updateIcon('QP', 'selectIcon')
        }

        CorbisUI.Search.Handler.refreshQuickPicBuddy();

        this.emptyItemDisplay(1);
    }
};

CorbisUI.Handlers.Cart = {

    addTo: function(CorbisId) {
        //console.log('CALLING: CorbisUI.Handlers.Cart.addTo');
        if (CorbisUI.Auth.GetSignInLevel() < 1) {
            CorbisUI.Auth.Check(1, CorbisUI.Auth.ActionTypes.Execute, "CorbisUI.Handlers.Cart.addProductToCart('" + CorbisId + "')");
        } else {
            CorbisUI.Handlers.Cart.addProductToCart(CorbisId);
        }
    },

    addProductToCart: function(CorbisId, reloadPage) {
        //console.log('CALLING: CorbisUI.Handlers.Cart.addProductToCart');
        var mediaId = CorbisUI.ProductCache.get(CorbisId);
        var product = CorbisUI.ProductCache.get(mediaId);
        product.refreshObject().setupObject();

        if (reloadPage) product.refreshPage = reloadPage;

        //if (product) product.refreshObject().setRefreshPage(reloadPage).addProductToCart();

        if (!product.activeStates.CT) {
            var addToCart = new CorbisUI.Cart.AddToCart(product.productUID);
            addToCart.context = product;
            addToCart.onSuccess = CorbisUI.Handlers.Cart.addToResponse;
            addToCart.refreshPage = reloadPage;
            addToCart.addOfferingToCart();
        }
    },

    addToResponse: function(results, context) {
        //console.log('CALLING: CorbisUI.Handlers.Cart.addToResponse');
        //console.log(results);
        //console.log(this.context);

        var thisItem
        if (context) {
            thisItem = context;
        }
        else if (this.context) {
            thisItem = this.context;
        }
        else {
            thisItem = this;
        }

        thisItem.setupObject();

        thisItem.updateIcon('CT', 'selectIcon');

        //update lighbox buddy
        var lightboxItem = CorbisUI.DomCache.get('LBXContainer').getElement('div[corbisid=' + thisItem.corbisID + ']');
        if (lightboxItem) {
            CorbisUI.Handlers.Lightbox.reloadLightbox(CorbisUI.DomCache.get('SBBX_lightboxes').getElement('select.lightboxList').value, null);
        }

        //update cart count
        UpdateCartCount(results);

        if (thisItem.refreshPage) {
            window.location = window.location;
        }
    },

    syncCartToImages: function() {
        //deselect all selected images
        CorbisUI.DomCache.get('productBlocks').each(function(el) {
            //var productBlock = el.retrieve('objectReference');
            var productid = el.getProperty('productuid');

            var productBlock = CorbisUI.ProductCache.get(productid);

            if (CorbisUI.cartMediaUidList.has(productid)) productBlock.updateIcon('CT', 'selectIcon');
        });

    },

    refreshItemAdded: function(mediaId, corbisId, cartCount) {
        //if there is a sign in link it means the user has just signed in and the whole page will need to be updated.
        //since the image result maybe different and the buddy would be different also.
        if ($(CorbisUI.GlobalVars.SearchResults.buddySignInLink)) {
            window.location.reload();
        }
        else {
            var productBlock = CorbisUI.ProductCache.get(mediaId);
            if (productBlock) {
                CorbisUI.Handlers.Cart.addToResponse(cartCount, productBlock);
            }
            else {
                //if there no product, we just update the buddy.
                var lightboxItem = $('LBXContainer').getElement('div[corbisid=' + corbisId + ']');
                if (lightboxItem) {
                    CorbisUI.Handlers.Lightbox.reloadLightbox(CorbisUI.DomCache.get('SBBX_lightboxes').getElement('select.lightboxList').value, null);
                }

                UpdateCartCount(cartCount);
            }
        }
    }
};

//TODO: refactor a this a little more
CorbisUI.cartMediaUidList = new Hash({});
function getCartMediaUidListResponse(results, context, methodName) {
    //console.log('getCartMediaUidListResponse:');
    //console.log(results);
    results.each(function(item) {
        CorbisUI.cartMediaUidList.set(item, true);
    });
    //cartMediaUidList = results;
}


/////////////////////////////////////
// WINDOW DOMREADY EVENTS
// if you add new functions,
// add them in statics
/////////////////////////////////////

// setup queue
CorbisUI.QueueManager.addQueue('searchDomReady', {
    canRerun: true,
    delay: true
}).addItem('domCacheSetup', function() {

    //todo: refactor
    //push the productuid list from the server during the page load, don't use the extra call from client
    Corbis.Web.UI.Search.SearchScriptService.GetCartMediaUidList(getCartMediaUidListResponse);

    // set some cached items
    CorbisUI.DomCache.add([
            'ProductResults',
            'hiddenWorkshop',
            'LBXContainer',
            'SBBX_lightboxes',
            'cartCount',
            'quickPicsContainer',
            'SearchBuddy',
            'modalOverlay',
            'FooterContent',
            'searchProgIndicator'
        ]);
    //if (window.location.href.toLowerCase().contains('imagegroups.aspx')) CorbisUI.DomCache.addObject('SBBX_lightboxes', $('SBBX_filters'));

    CorbisUI.DomCache.addCollection('productBlocks', CorbisUI.DomCache.get('ProductResults').getElements('span.ProductBlock'));

    if ($('goBtn') != null) {
        var removeAction = ";$('goBtn').getElement('a').removeAttribute('href');";
        var href = $('goBtn').getElement('a').getAttribute('href') + removeAction;
        $('goBtn').getElement('a').setAttribute('href', href);
    }


}).addItem('simplestuff', function() {
    registerTooltips(false);
    setEditorialCheckedState(true);
    noPeopleChanged(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.noPeople);
}).addItem('productBlockSetup', function() {
    // apply product block objects to dom elements
    CorbisUI.DomCache.get('productBlocks').each(function(el) {
        var item = new CorbisUI.SearchModels.ProductBlock(el);
    });
}).addItem('finalItems', function() {
    //search term clarification
    var displayClarificationPopup = $(CorbisUI.GlobalVars.SearchResults.showClarificationPopup);
    if (displayClarificationPopup.value == 'true' || displayClarificationPopup.value == 'True') {
        OpenAmbiguousModal();
    }

    var getZeroSearchResults = $(CorbisUI.GlobalVars.SearchResults.zeroSearchResults).value;
    if (getZeroSearchResults == 'True') {
        applyZeroResultsStyles();
    }

    // load lightbox data for imagegroups
    if (window.location.href.toLowerCase().contains('imagegroups.aspx')) {
        this.dataLoaded = true;
        //handle data load
        // 1 grab lightboxId
        //var lightboxDropdown = this.getElement('select[name$=lightboxList]');
        // 2 call web service
        //var lightboxId = lightboxDropdown.getSelected();

        var selectedList = CorbisUI.DomCache.get('SBBX_lightboxes').getElement('select.lightboxList');
        if (selectedList != null && selectedList.getSelected()[0] != null) {

            var selectedIndex = selectedList.selectedIndex;
            var lightboxId = selectedList.options[selectedIndex].value;

            //console.log(lightboxId);
            // 3 return handling
            //Corbis.Web.UI.Search.SearchScriptService.GetLightBoxItems(lightboxId, this.getLightboxItemsCallback.bind(this));
            // 4 lightbox items display

            // LAUNCH the getLightboxItems handler
            CorbisUI.Handlers.Lightbox.getLightboxItems(lightboxId);
        }
    }
});

// setup the queue to run
if (window.location.href.toLowerCase().contains('searchresults.aspx') || window.location.href.toLowerCase().contains('imagegroups.aspx')) {
    CorbisUI.QueueManager.searchDomReady.setupDomReady();
}

/////////////////////////////////////
// SERVICE FUNCTIONS?
/////////////////////////////////////

function methodFailed(results, context, methodName)
{
    //console.log(results);
    //TODO: use mochaUI for alert window
    alert(results.get_message());
}

function endRequestHandler(sender, args) {
    //alert(sender._postBackSettings.sourceElement.id);
    if (sender._postBackSettings.sourceElement && 
                ( sender._postBackSettings.sourceElement.id.contains('quickpicField')
                  || sender._postBackSettings.sourceElement.id.contains('addToLightboxBtn'))
       )
        return;
}        

function registerTooltips(isFirstTime)
{
   
    $('aspnetForm').getAllNext('.TIP-product-block').destroy();
    
    var tipShowDelay = 500;
    var tipHideDelay = 100;
    var tipShowMethod = "in";
    var tipHideMethod = "out";
    if(Browser.Engine.trident) {
        tipShowDelay = 0;
        tipHideDelay = 0;
        tipShowMethod = "show";
        tipHideMethod = "hide";
    }
    thumbTips = new Tips('#ProductResults .thumbWrap', {
        showDelay: tipShowDelay,
        hideDelay: tipHideDelay,
        className: 'TIP-product-block', 
        onHide: function(tip){
            if (showTooltip()) tip.fade(tipHideMethod);
        }, 
        onShow:function(tip) {
            if (showTooltip()) tip.fade(tipShowMethod);
        }
    });

}

function showTooltip()
{
    return ($$('.previewOffSelected').length == 0);
}

function InitiateTimer() {
// No longer used - 15065
	if (timer!=null)window.clearInterval(timer);
	timer = window.setInterval("window.clearInterval(timer);if (testSBCategoriesChecked()) secondTimer()", 2000);
}

function resetSearchCategoryChecks() {
    // kill the search timer first
    //stopSearch = true;
    if (timer != null) window.clearInterval(timer);
    if (timer2 != null) window.clearInterval(timer2);
    // reset the checks
    setCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.creative, true);
    setCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.editorial, true);
    setCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.rmLicense, true);
    setCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.rfLicense, true);
    setCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.noPeople, false);
    setCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.photography, true);
    setCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.illustration, true);
    setCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.color, true);
    setCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.blackWhite, true);
    setCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.onlyModelReleased, false);
    // clearn up the triggered timer
//    if (timer != null) window.clearInterval(timer);
//    if (timer2 != null) window.clearInterval(timer2);
    //
}

function testSBCategoriesChecked()
{
if (window.location.href.toLowerCase().contains('searchresults.aspx')) 
   {
    noLicense = !getCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.rmLicense) && 
        !getCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.rfLicense);
    noCat = !getCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.editorial) && 
        !getCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.creative);
    noPhoto = !getCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.photography) && 
        !getCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.illustration);
    noColor = !getCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.color) && 
        !getCheckedState(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.blackWhite);
        
    var noResults = noLicense || noCat || noColor || noPhoto;
    
    //alert(noResults);
    if (noResults)
    {
        if (!$('noSearchResultsWarningWindow'))
        {
            var sbCoords = CorbisUI.DomCache.get('SearchBuddy').getCoordinates();
            var sbScroll = $(document.body).getScroll();
            var scrollOffset = sbCoords.top + sbScroll.y;
            var vPos = noCat ? 10 : noLicense ? 98 : noPhoto ? 232 : 287;
            vPos += scrollOffset;
            new CorbisUI.Popup('noSearchResultsWarning', { 
                createFromHTML: true,
                showModalBackground: false,
                centerOverElement: 'noSearchResultsWarning',
                closeOnLoseFocus: true,
                positionVert: vPos, 
                positionHoriz: 212,
                replaceText: [ '' ]
            });
            setTimeout(setErrorOptions, 100);
        }
        return false;
    }
    else
    {
        MochaUI.CloseModal('noSearchResultsWarning');
        return true;
    }
    }
}

function setErrorOptions()
{
    var pop = $('noSearchResultsWarningWindow');
    if (!pop) return false;
    
    var items = {
        license : pop.getElement('p[textKey=License]'),
        category : pop.getElement('p[textKey=Category]'),
        color : pop.getElement('p[textKey=Color]'),
        photo : pop.getElement('p[textKey=Photo]')
    }
    
    items.license.setStyle('display', 'none');
    items.category.setStyle('display', 'none');
    items.color.setStyle('display', 'none');
    items.photo.setStyle('display', 'none');
    
    if (noCat)
        items.category.setStyle('display', 'block');
    else if (noLicense)
        items.license.setStyle('display', 'block');
    else if (noColor)
        items.color.setStyle('display', 'block');
    else if (noPhoto)
        items.photo.setStyle('display', 'block');

    CorbisUI.DomCache.get('modalOverlay').addEvent('click', function() {
        $(this).setStyle('display', 'none');
    });
    CorbisUI.DomCache.get('searchProgIndicator').setStyle('display', 'none');
    
}

// This is no longer used
function secondTimer() {
    if (stopSearch) {
        if (timer) window.clearInterval(timer);
        if (timer2) window.clearInterval(timer2);
        stopSearch = false;
        return;
    }
    if (timer2 != null) window.clearInterval(timer);
	timer2 = window.setInterval("window.clearInterval(timer2);invokeSearch(true)", 1500);
	CorbisUI.DomCache.get('searchProgIndicator')
	    .setStyles({
	        'display': 'block',
	        'height': document.body.scrollHeight + 'px',
	        'left': '206px'
	    });
	$('processingFilters').setStyle('display', 'block');
}

function noPeopleChanged(chk)
{
   if (window.location.href.toLowerCase().contains('searchresults.aspx')) 
   {
    var checked = getCheckedState(chk);
    $('divNoPeopleIcon')
        .setStyle('background-position', checked ? 'bottom right' : 'top right');
   }

}
function EditorialChanged(checked)
{
    var checks = $('EditorialChildren').getElements('div.imageCheckbox');

    checks.each(function(cb){
        setCheckedNoEvent(cb, checked)
    });
}

function setEditorialCheckedState(init)
{
    if (window.location.href.toLowerCase().contains('searchresults.aspx')) {
        var editorialCB = $(CorbisUI.GlobalVars.SearchResults.checkBoxIDS.editorial);
        var allUnchecked = true;
        var div = $('EditorialChildren');
        var checks = div.getElements('div.imageCheckbox');

        checks.each(function(cb) {
            if (getCheckedState(cb)) allUnchecked = false;
        });

        (allUnchecked) ? setCheckedNoEvent(editorialCB, false) : setCheckedNoEvent(editorialCB, true);
        
    }
}
//var showTooltip = $$('previewOffSelected');
function openCreateLightbox()
{

    //console.log('CALLING: openCreateLightbox');
    
	if (!CorbisUI.GlobalVars.SearchResults.isAnonymous)
	{
	    new CorbisUI.Popup('createLightboxModalPopup', { 
			showModalBackground: false,
			centerOverElement: 'SearchBuddy',
			closeOnLoseFocus: true,
			positionVert: '60', 
			positionHoriz: '5'
		});

		//Reposition because getCoordinate() does not work so well for Safari.
		var SB = CorbisUI.DomCache.get('SearchBuddy');
		$('createLightboxModalPopupWindow').setStyles({
			top: SB.offsetTop + window.getScroll().y + 60,
			left: SB.offsetLeft + window.getScroll().x + 5
		});

		var clmpw = $('createLightboxModalPopup');
		//Use cancel button ID to retrieve the cancel button . See Bug 17818
		var group = new Hash({
            'mo': $('modalOverlay'),
            'close': clmpw.getElement('div.ModalTitleBar input.Close'),
            'cancel': $(CorbisUI.GlobalVars.CreateLightbox.cancelButtonID)
        });

        closeLightboxEvent = CloseCreateLightbox.bindWithEvent(clmpw, group);
            
        group.each(function(value,key,hash){
            hash.get(key).addEvent('click',closeLightboxEvent);
        });            		
            
		ResizeModal('createLightboxModalPopup');
		setTimeout('$(CorbisUI.GlobalVars.CreateLightbox.newLightboxName).focus();$(CorbisUI.GlobalVars.CreateLightbox.newLightboxName).select();', 500);            
	}
}

function CloseCreateLightbox(e, grp)
{
    var validationSummary = this.getElement('.ValidationSummary');
    if (validationSummary != null) {
        validationSummary.setStyle('display', 'none');
    }

    var newNameField = this.getElement('input[type=text]');
    newNameField.value = '';
    newNameField.setStyle('color', '#333333');

    grp.each(function(value, key, hash) {
        hash.get(key).removeEvent('click', closeLightboxEvent);
    });
    grp = $lambda(false);    
}

function createLightbox_success(){
    //console.log('CALLING: createLightbox_success');
    CorbisUI.DomCache.get(['LBXContainer', 'SBBX_lightboxes'], true);
}

function confirmItemAdded(link)//icon_cart_selected
{
    new CorbisUI.Popup('addToCartConfirm', { 
        createFromHTML: true,
        showModalBackground: false,
        centerOverElement: link,
        closeOnLoseFocus: true,
        positionVert: 'top', 
        positionHoriz: 'center',
        replaceText: []
    });
    return false;
}

function OpenAmbiguousModal(element)
{
    new CorbisUI.Popup('ambiguousModal');
    setGlassButtonDisabled(CorbisUI.GlobalVars.SearchResults.clarificationUpdate, true);
    ResizeModal('ambiguousModal');  
}

function applyZeroResultsStyles() {
    CorbisUI.DomCache.get('FooterContent').addClass('zeroResults');
    CorbisUI.DomCache.get('SearchBuddy').addClass('zeroResultsBuddy');
}
        
function updateClarificationCount(isChecked)
{
    (isChecked) ? _clarifyCheckCount++ : _clarifyCheckCount--;
    setGlassButtonDisabled(CorbisUI.GlobalVars.SearchResults.clarificationUpdate, _clarifyCheckCount < 1);
}

function getClarifactionChecked(method)
{
    var base = $('ambiguousModal');
    var clarificationGroups = base.getElements('.Clarification');
    var clarificationString = '';

    clarificationGroups.each(function(el) {
        clarificationString += ',';

        el.getElements('.checkboxWrap').each(function(itemEl) {
            var cbx = itemEl.getElement('input[type=checkbox]');
            (cbx.checked) ? cbx.value = 1 : cbx.value = 0;
            clarificationString += cbx.value;
        });
    });

    clarificationString = clarificationString.substring(1);
    var queryFlags = $(CorbisUI.GlobalVars.SearchResults.clarificationQueryFlags);
    queryFlags.value = clarificationString;
    if (method == "cancel") {
        HideModal('ambiguousModal');
    } else {
        MochaUI.CloseModal('ambiguousModal');
        //CorbisUI.ExtendedSearch.validateSearch();
        return clarificationString;
    }
    
    
}
